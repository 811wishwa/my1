
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>💾 Link Saver Chat</title>
<style>
body { font-family: Arial; background: #f4f4f4; padding: 20px; }
h2 { text-align: center; }
#chat-box { background: #fff; border-radius: 10px; padding: 10px; height: 450px; overflow-y: auto; }
.message { background: #e6f3ff; border-radius: 8px; padding: 8px 12px; margin: 8px 0; }
.link-preview { background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 8px; margin-top: 5px; display:flex; gap:10px; align-items:flex-start; }
.link-preview img { width: 120px; height: 90px; object-fit: cover; border-radius: 6px; }
#input-area { display:flex; gap: 8px; margin-top:10px; }
input, select, button { padding: 8px; border-radius:5px; border:1px solid #ccc; }
button { background: #007bff; color: white; cursor:pointer; border:none; }
.player-container { width: 100%; max-width: 560px; margin-top: 5px; }
.player-container iframe { width: 100%; height: 315px; border: 0; }
</style>
</head>
<body>

<h2>💾 Link Saver Chat</h2>

<div style="text-align:center; margin-bottom:10px;">
  <label for="api-select">Select API: </label>
  <select id="api-select">
    <option value="linkPreview">LinkPreview</option>
    <option value="microlink">Microlink.io</option>
    <option value="iframely">Iframely</option>
    <option value="noembed">Noembed</option>
  </select>
</div>

<div id="chat-box"></div>

<div id="input-area">
  <input type="text" id="message-input" placeholder="Type message or paste a link..." />
  <button id="send-btn">Send</button>
</div>

<script>
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const apiSelect = document.getElementById("api-select");

const apiKeys = {
  linkPreview: 'a22398b655223c837bf83d7aa173fef2',
  iframely: '7b7bdfd747591112e2adda',
  microlink: null
};

function extractUrls(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.match(urlRegex);
}

async function fetchPreview(url, apiName) {
  try {
    if(apiName === 'linkPreview'){
      const res = await fetch(`https://api.linkpreview.net/?key=${apiKeys.linkPreview}&q=${encodeURIComponent(url)}`);
      const data = await res.json();
      return { title: data.title, description: data.description, image: data.image };

    } else if(apiName === 'microlink'){
      let endpoint = `https://api.microlink.io?url=${encodeURIComponent(url)}&meta=true`;
      if(apiKeys.microlink) endpoint += `&apiKey=${apiKeys.microlink}`;
      const res = await fetch(endpoint);
      const data = await res.json();
      return { title: data.data?.title, description: data.data?.description, image: data.data?.image?.url };

    } else if(apiName === 'iframely'){
      const res = await fetch(`https://iframe.ly/api/iframely?url=${encodeURIComponent(url)}&api_key=${apiKeys.iframely}`);
      const data = await res.json();

      // Try meta image first
      let imageUrl = data.meta?.image;
      // Fallback to thumbnail array
      if(!imageUrl && data.links?.thumbnail?.length > 0){
        imageUrl = data.links.thumbnail[0].href;
      }
      // Player HTML if available
      let playerHTML = data.links?.player?.length > 0 ? data.links.player[0].html : null;

      return { title: data.meta?.title || data.meta?.site, description: data.meta?.description || '', image: imageUrl, playerHTML };

    } else if(apiName === 'noembed'){
      const res = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
      const data = await res.json();
      return { title: data.title, description: data.author_name || '', image: data.thumbnail_url };
    }
  } catch(err){
    console.warn(`${apiName} failed: ${err.message}`);
    return null;
  }
}

async function showLinkPreview(url, container){
  const apiName = apiSelect.value;
  const preview = await fetchPreview(url, apiName);
  if(preview){
    if(preview.playerHTML){
      const playerDiv = document.createElement('div');
      playerDiv.className = 'player-container';
      playerDiv.innerHTML = preview.playerHTML;
      container.appendChild(playerDiv);
    } else if(preview.image || preview.title){
      const card = document.createElement('div');
      card.className = 'link-preview';
      card.innerHTML = `
        ${preview.image ? `<img src="${preview.image}" alt="">` : ""}
        <div>
          <h4>${preview.title || 'No title'}</h4>
          <p>${preview.description || ''}</p>
          <a href="${url}" target="_blank">${url}</a>
        </div>
      `;
      container.appendChild(card);
    } else {
      const failMsg = document.createElement('div');
      failMsg.textContent = `⚠️ No preview available from ${apiName}.`;
      container.appendChild(failMsg);
    }
  } else {
    const failMsg = document.createElement('div');
    failMsg.textContent = `⚠️ Failed to fetch preview from ${apiName}.`;
    container.appendChild(failMsg);
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}

function sendMessage(){
  const text = input.value.trim();
  if(!text) return;
  input.value = '';

  const msgDiv = document.createElement('div');
  msgDiv.className = 'message';
  msgDiv.textContent = text;
  chatBox.appendChild(msgDiv);

  const urls = extractUrls(text);
  if(urls && urls.length>0) showLinkPreview(urls[0], msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

sendBtn.onclick = sendMessage;
input.addEventListener("keypress", e => { if(e.key === "Enter") sendMessage(); });
</script>
</body>
</html>

